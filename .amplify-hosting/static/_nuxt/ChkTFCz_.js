import{f as L,j as u,g as C,_ as M,t as O,l as j,o as x,a as $,w as F,p as b,V as D,G as S,s as G,v as U,b as T,A as H,y as J,q as K}from"./CGQimWOm.js";import{V as Q}from"./DJ0NdY24.js";const W=L("useUserFans",()=>{const l=u([]),g=u([]),i=u(!1),d=u(!1),v=u(""),h=u({currentPage:1,lastPage:1,total:0}),t=u({currentPage:1,lastPage:1,total:0}),o=u({}),p=u({}),f=u({}),n=u({}),{$axios:s}=C();async function _(a,e,r,c,w="",P=!1){if(P&&(r.value.currentPage=1,e.value=[]),!(r.value.currentPage>r.value.lastPage||i.value)){i.value=!0,d.value=!1,v.value="";try{const y=await s.get(a,{params:{search:w,page:r.value.currentPage}}),m=y.data[a.includes("fans")?"fans":"fanning"];r.value.currentPage===1||P?e.value=m:e.value.push(...m),r.value={currentPage:y.data.pagination.current_page+1,lastPage:y.data.pagination.last_page,total:y.data.pagination.total}}catch(y){console.error(`Failed to fetch ${a}:`,y),d.value=!0,v.value=`Failed to fetch ${a.includes("fans")?"fans":"fanning"}. Please try again later.`}finally{i.value=!1}}}async function V(a,e="",r=!1){await _(`/api/fans/${a}/fans`,l,h,a,e,r)}async function E(a,e="",r=!1){await _(`/api/fans/${a}/fanning`,g,t,a,e,r)}async function z(a){if(n.value[a])return f.value[a]||{is_fanning:!1,fan_count:0};n.value[a]=!0;try{const e=await s.get(`/api/fans/${a}/status`);return e.data.success?(f.value[a]=e.data.data,o.value[a]=e.data.data.fan_count,e.data.data):{is_fanning:!1,fan_count:0}}catch(e){return console.error("Error fetching fan status:",e),{is_fanning:!1,fan_count:0}}finally{n.value[a]=!1}}async function I(a){var e,r;n.value[a]=!0;try{const c=await s.post(`/api/fans/${a}/toggle`);return c.data.success?(f.value[a]=c.data.data,o.value[a]=c.data.data.fan_count,A(a,c.data.data.is_fanning),{success:!0,...c.data.data}):{success:!1,message:"Failed to update fan status"}}catch(c){return console.error("Error toggling fan status:",c),{success:!1,message:((r=(e=c.response)==null?void 0:e.data)==null?void 0:r.message)||"An error occurred"}}finally{n.value[a]=!1}}function A(a,e){const r=l.value.findIndex(w=>w.username===a);r!==-1&&(l.value[r].is_fanned_by_auth_user=e);const c=g.value.findIndex(w=>w.username===a);c!==-1&&(g.value[c].is_fanned_by_auth_user=e)}async function B(a){try{if(f.value[a])return o.value[a]=f.value[a].fan_count,o.value[a];const e=await s.get(`/api/fans/${a}/fans/count`);return o.value[a]=e.data.count,o.value[a]}catch(e){throw console.error("Error fetching fan count:",e),e}}async function N(a){try{const e=await s.get(`/api/fans/${a}/fanning/count`);return p.value[a]=e.data.count,p.value[a]}catch(e){throw console.error("Error fetching fanning count:",e),e}}function k(a=null){a?delete f.value[a]:f.value={}}function q(){l.value=[],g.value=[],i.value=!1,d.value=!1,v.value="",h.value={currentPage:1,lastPage:1,total:0},t.value={currentPage:1,lastPage:1,total:0},o.value={},p.value={},f.value={},n.value={}}return{fans:l,fanning:g,isFetching:i,isError:d,errorMessage:v,fansPagination:h,fanningPagination:t,fanCounts:o,fanningCounts:p,fanStatusCache:f,loading:n,fetchFans:V,fetchFanning:E,fetchFansCount:B,fetchFanningCount:N,getFanStatus:z,toggleFan:I,clearCache:k,$reset:q}}),X={class:"fan-text"},Y={__name:"FanButton",props:{username:{type:String,required:!0},size:{type:String,default:"medium",validator:l=>["small","medium","large"].includes(l)},disabled:{type:Boolean,default:!1}},emits:["fanningUpdated"],setup(l,{emit:g}){const i=l,d=g,v=C(),h=W(),t=u(!1),o=u(!1),p=async()=>{if(i.username)try{const n=await h.getFanStatus(i.username);t.value=n.is_fanning}catch(n){console.error("Error loading fan status:",n)}},f=async()=>{if(o.value||i.disabled)return;const n=t.value;t.value=!t.value,o.value=!0,d("fanningUpdated",t.value);try{await v.$protectedAction(async()=>{const s=await h.toggleFan(i.username);if(s.success)return t.value=s.is_fanning,d("fanningUpdated",s.is_fanning),s;throw new Error(s.message||"Failed to update fan status")},{onSuccess:()=>{console.log(`User ${t.value?"fanned":"unfanned"} successfully`)},onError:s=>{var _;t.value=n,d("fanningUpdated",n),console.error("Error updating fan status:",s),(_=v.$toast)==null||_.error("Failed to update fan status. Please try again.")},requiresAuth:!0})}catch(s){t.value=n,d("fanningUpdated",n),console.error("Unexpected error:",s)}finally{o.value=!1}};return O(()=>i.username,p),j(p),(n,s)=>(x(),$(K,{color:t.value?"primary":"surface-variant",variant:t.value?"flat":"outlined",onClick:f,rounded:"pill",class:S({"fan-btn":!0,"fan-btn--active":t.value,[`fan-btn--${l.size}`]:!0}),"min-width":l.size==="small"?80:l.size==="large"?120:100,disabled:l.disabled,elevation:"2"},{default:F(()=>[b(D,{class:S(["fan-icon",{"fan-icon--active":t.value}]),size:"small",start:""},{default:F(()=>[G(U(t.value?"mdi-heart":"mdi-heart-outline"),1)]),_:1},8,["class"]),T("span",X,U(t.value?"Following":"Follow"),1),o.value?(x(),$(Q,{key:0,contained:"",class:"loading-overlay",opacity:"0.3"},{default:F(()=>[b(H,{indeterminate:"",size:"16",width:"2",color:"primary"})]),_:1})):J("",!0)]),_:1},8,["color","variant","class","min-width","disabled"]))}},aa=M(Y,[["__scopeId","data-v-a936beb5"]]);export{aa as _};
