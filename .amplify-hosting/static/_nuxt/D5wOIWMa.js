import{f as I,g as L,j as f,c as x}from"./CGQimWOm.js";import{u as j}from"./CYM4bMtk.js";import{u as B}from"./CE0NNlNx.js";import{s as k}from"./rtPmyJLL.js";function E(v){var _,s,u,d;const g=(s=(_=v.response)==null?void 0:_.data)==null?void 0:s.logs;return g&&Array.isArray(g)&&g.length>0?g[0].error_message||"An error occurred":((d=(u=v.response)==null?void 0:u.data)==null?void 0:d.message)||v.message||"An error occurred"}const J=I("premieringMediaUpload",()=>{const{$axios:v}=L(),{subscribeTo:g,unsubscribeFrom:_}=j(),s=f(null),u=f(null),d=f(!1),U=f(!1),z=f({xhr:null}),T=f({xhr:null}),i=f({isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}),a=f({isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}),R=x(()=>s.value!==null&&i.value.processingStatus!=="failed"),C=x(()=>i.value.isUploading||a.value.isUploading);async function M(e){var r;U.value=!0,u.value=null,d.value=!1;try{const{data:l}=await v.post("/api/studio/projects/create",e);l!=null&&l.project&&(s.value=l.project,P())}catch(l){const n=(r=l.response)==null?void 0:r.status,o=E(l);throw n===422&&o.toLowerCase().includes("insufficient balance")&&(d.value=!0),u.value=o,l}finally{U.value=!1}}function y(e){s.value?s.value={...s.value,...e}:s.value=e,s.value.project_url?(i.value.processingStatus="completed",i.value.fileUrl=s.value.project_url,i.value.manifestUrl=s.value.project_url,i.value.progress=100):i.value.isUploading||(i.value.processingStatus="pending"),s.value.trailer_url?(a.value.processingStatus="completed",a.value.fileUrl=s.value.trailer_url,a.value.manifestUrl=s.value.trailer_url,a.value.progress=100):a.value.isUploading||(a.value.processingStatus="pending")}function S(e){if(y(e),e.main_meta&&i.value.fileName===null&&(i.value.fileName=e.name||e.main_meta.original_filename||null,i.value.fileSize=e.main_meta.original_filesize||0,i.value.uploadedSize=e.main_meta.original_filesize||0),e.trailer_meta&&a.value.fileName===null&&(a.value.fileName=e.trailer_meta.original_filename||null,a.value.fileSize=e.trailer_meta.original_filesize||0,a.value.uploadedSize=e.trailer_meta.original_filesize||0),e.logs&&e.logs.length>0){const r=e.logs.filter(c=>c.file_type==="main"),l=r.length>0?r[r.length-1]:null;l&&!i.value.isUploading&&(i.value.processingStatus=l.processing_status,l.processing_status==="failed"&&l.error_message&&(u.value=l.error_message));const n=e.logs.filter(c=>c.file_type==="trailer"),o=n.length>0?n[n.length-1]:null;o&&!a.value.isUploading&&(a.value.processingStatus=o.processing_status,o.processing_status==="failed"&&o.error_message&&(u.value=o.error_message))}e.main_upload_status&&(e.main_upload_status==="completed"?(i.value.processingStatus="completed",i.value.progress=100,i.value.isUploading=!1):e.main_upload_status==="failed"?(i.value.processingStatus="failed",i.value.isUploading=!1):e.main_upload_status==="processing"&&(i.value.processingStatus="processing",i.value.progress=99)),e.trailer_upload_status&&(e.trailer_upload_status==="completed"?(a.value.processingStatus="completed",a.value.progress=100,a.value.isUploading=!1):e.trailer_upload_status==="failed"?(a.value.processingStatus="failed",a.value.isUploading=!1):e.trailer_upload_status==="processing"&&(a.value.processingStatus="processing",a.value.progress=99))}async function $(e,r){var o,c;const l=r==="main"?i:a,n=r==="main"?z:T;try{l.value.isUploading=!0,l.value.fileName=e.name,l.value.fileSize=e.size,l.value.progress=0,l.value.error=null,l.value.startTime=Date.now(),l.value.speed=0,l.value.estimatedTimeRemaining=0,u.value=null;const{uploadFile:m}=B();await m(e,`/api/studio/projects/${(o=s.value)==null?void 0:o.access_uuid}/presigned-url`,`/api/studio/projects/${(c=s.value)==null?void 0:c.access_uuid}/confirm-upload`,{fileType:r,onProgress:p=>{F(l,p/100*e.size,e.size)},onSuccess:()=>{l.value.processingStatus="processing",l.value.progress=99},onError:p=>{throw p}})}catch(m){const p=E(m);throw l.value.error=p,l.value.processingStatus="failed",l.value.isUploading=!1,u.value=p,new Error(p)}finally{n.value.xhr=null}}function h(e){const r=e==="main"?z:T,l=e==="main"?i:a;if(r.value.xhr)try{r.value.xhr.abort()}catch(n){console.error("Error aborting XHR:",n)}r.value.xhr=null,l.value={isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}}function F(e,r,l){const n=Date.now();e.value.startTime||(e.value.startTime=n);const o=Math.round(r/l*100),c=(n-e.value.startTime)/1e3,m=r/c,A=(l-r)/m;e.value.progress=o,e.value.uploadedSize=r,e.value.speed=m,e.value.estimatedTimeRemaining=A}let t=null;function P(){if(s.value)try{const e=g(`project.${s.value.id}.main`),r=g(`project.${s.value.id}.trailer`);e&&e.bind("VideoProcessed",l=>{console.log("Main VideoProcessed event received:",l),b(l,"main")}),r&&r.bind("VideoProcessed",l=>{console.log("Trailer VideoProcessed event received:",l),b(l,"trailer")}),w()}catch(e){console.error("Error subscribing to processing updates:",e),u.value="Failed to setup processing notifications",w()}}function b(e,r){var l;try{if(e.project.access_uuid!==((l=s.value)==null?void 0:l.access_uuid)||e.fileType!==r)return;t&&(clearInterval(t),t=null),S(e.project);const n=e.fileType==="main"?i:a,o=e.fileType==="main"?e.project.main_upload_status:e.project.trailer_upload_status;o==="completed"||o==="failed"?(n.value.processingStatus=o==="completed"?"completed":"failed",n.value.progress=o==="completed"?100:0,n.value.isUploading=!1):o==="processing"&&(n.value.processingStatus="processing",n.value.progress=99),e.manifestUrl&&(n.value.manifestUrl=e.manifestUrl,n.value.fileUrl=e.manifestUrl),e.failCause&&(n.value.error=e.failCause,u.value=e.failCause)}catch(n){console.error("Error processing VideoProcessed event:",n),u.value="Error processing video update"}}function w(){t||(t=k(async()=>{if(s.value)try{const{data:e}=await v.get(`/api/studio/projects/${s.value.access_uuid}`);if(e!=null&&e.project){S(e.project);const r=["completed","failed"].includes(e.project.main_upload_status),l=["completed","failed","pending"].includes(e.project.trailer_upload_status);r&&l&&(clearInterval(t),t=null)}}catch(e){console.error("Polling error:",e)}},5e3))}function V(){s.value&&(_(`project.${s.value.id}.main`),_(`project.${s.value.id}.trailer`)),t&&(clearInterval(t),t=null),h("main"),h("trailer"),s.value=null,u.value=null,d.value=!1,N()}function N(){i.value={isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null},a.value={isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}}return{project:s,error:u,insufficientFunds:d,isLoading:U,mainUpload:i,trailerUpload:a,canUploadTrailer:R,isAnyUploadInProgress:C,createProject:M,uploadFile:$,cancelUpload:h,cleanup:V,resetUploadStates:N,subscribeToProcessingUpdates:P,updateUploadStateFromProject:S,updateProject:y}});export{J as u};
