import{bg as e,bh as t}from"./server.mjs";import"vue";import"node:http";import"node:https";import"node:zlib";import"node:stream";import"node:buffer";import"node:util";import"node:url";import"node:net";import"node:fs";import"node:path";import"../_/nitro.mjs";import"consola/core";import"nuxt-site-config/urls";import"ipx";import"unhead";import"vue-router";import"pinia-plugin-persistedstate";import"vue/server-renderer";var r=Object.defineProperty,E=(e,t)=>r(e,"name",{value:t,configurable:!0});let n=0;const a={START_BOUNDARY:n++,HEADER_FIELD_START:n++,HEADER_FIELD:n++,HEADER_VALUE_START:n++,HEADER_VALUE:n++,HEADER_VALUE_ALMOST_DONE:n++,HEADERS_ALMOST_DONE:n++,PART_DATA_START:n++,PART_DATA:n++,END:n++};let o=1;const i=o,s=o*=2,d=E((e=>32|e),"lower"),l=E((()=>{}),"noop"),A=class{constructor(e){this.index=0,this.flags=0,this.onHeaderEnd=l,this.onHeaderField=l,this.onHeadersEnd=l,this.onHeaderValue=l,this.onPartBegin=l,this.onPartData=l,this.onPartEnd=l,this.boundaryChars={},e="\r\n--"+e;const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r),this.boundaryChars[t[r]]=!0;this.boundary=t,this.lookbehind=new Uint8Array(this.boundary.length+8),this.state=a.START_BOUNDARY}write(e){let t=0;const r=e.length;let n=this.index,{lookbehind:o,boundary:l,boundaryChars:A,index:h,state:c,flags:D}=this;const f=this.boundary.length,T=f-1,p=e.length;let u,_;const R=E((e=>{this[e+"Mark"]=t}),"mark"),m=E((e=>{delete this[e+"Mark"]}),"clear"),b=E(((e,t,r,n)=>{(void 0===t||t!==r)&&this[e](n&&n.subarray(t,r))}),"callback"),H=E(((r,n)=>{const a=r+"Mark";a in this&&(n?(b(r,this[a],t,e),delete this[a]):(b(r,this[a],e.length,e),this[a]=0))}),"dataCallback");for(t=0;t<r;t++)switch(u=e[t],c){case a.START_BOUNDARY:if(h===l.length-2){if(45===u)D|=s;else if(13!==u)return;h++;break}if(h-1==l.length-2){if(D&s&&45===u)c=a.END,D=0;else{if(D&s||10!==u)return;h=0,b("onPartBegin"),c=a.HEADER_FIELD_START}break}u!==l[h+2]&&(h=-2),u===l[h+2]&&h++;break;case a.HEADER_FIELD_START:c=a.HEADER_FIELD,R("onHeaderField"),h=0;case a.HEADER_FIELD:if(13===u){m("onHeaderField"),c=a.HEADERS_ALMOST_DONE;break}if(h++,45===u)break;if(58===u){if(1===h)return;H("onHeaderField",!0),c=a.HEADER_VALUE_START;break}if(_=d(u),_<97||_>122)return;break;case a.HEADER_VALUE_START:if(32===u)break;R("onHeaderValue"),c=a.HEADER_VALUE;case a.HEADER_VALUE:13===u&&(H("onHeaderValue",!0),b("onHeaderEnd"),c=a.HEADER_VALUE_ALMOST_DONE);break;case a.HEADER_VALUE_ALMOST_DONE:if(10!==u)return;c=a.HEADER_FIELD_START;break;case a.HEADERS_ALMOST_DONE:if(10!==u)return;b("onHeadersEnd"),c=a.PART_DATA_START;break;case a.PART_DATA_START:c=a.PART_DATA,R("onPartData");case a.PART_DATA:if(n=h,0===h){for(t+=T;t<p&&!(e[t]in A);)t+=f;t-=T,u=e[t]}if(h<l.length)l[h]===u?(0===h&&H("onPartData",!0),h++):h=0;else if(h===l.length)h++,13===u?D|=i:45===u?D|=s:h=0;else if(h-1===l.length)if(D&i){if(h=0,10===u){D&=~i,b("onPartEnd"),b("onPartBegin"),c=a.HEADER_FIELD_START;break}}else D&s&&45===u?(b("onPartEnd"),c=a.END,D=0):h=0;if(h>0)o[h-1]=u;else if(n>0){const e=new Uint8Array(o.buffer,o.byteOffset,o.byteLength);b("onPartData",0,n,e),n=0,R("onPartData"),t--}break;case a.END:break;default:throw new Error(`Unexpected state entered: ${c}`)}H("onHeaderField"),H("onHeaderValue"),H("onPartData"),this.index=h,this.state=c,this.flags=D}end(){if(this.state===a.HEADER_FIELD_START&&0===this.index||this.state===a.PART_DATA&&this.index===this.boundary.length)this.onPartEnd();else if(this.state!==a.END)throw new Error("MultipartParser.end(): stream ended unexpectedly")}};E(A,"MultipartParser");let h=A;function v(e){const t=e.match(/\bfilename=("(.*?)"|([^()<>@,;:\\"/[\]?={}\s\t]+))($|;\s)/i);if(!t)return;const r=t[2]||t[3]||"";let n=r.slice(r.lastIndexOf("\\")+1);return n=n.replace(/%22/g,'"'),n=n.replace(/&#(\d{4});/g,((e,t)=>String.fromCharCode(t))),n}async function Z(r,n){if(!/multipart/i.test(n))throw new TypeError("Failed to fetch");const a=n.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!a)throw new TypeError("no or bad content-type header, no multipart boundary");const o=new h(a[1]||a[2]);let i,s,d,l,A,c;const D=[],f=new e,T=E((e=>{d+=R.decode(e,{stream:!0})}),"onPartData"),p=E((e=>{D.push(e)}),"appendToFile"),u=E((()=>{const e=new t(D,c,{type:A});f.append(l,e)}),"appendFileToFormData"),_=E((()=>{f.append(l,d)}),"appendEntryToFormData"),R=new TextDecoder("utf-8");R.decode(),o.onPartBegin=function(){o.onPartData=T,o.onPartEnd=_,i="",s="",d="",l="",A="",c=null,D.length=0},o.onHeaderField=function(e){i+=R.decode(e,{stream:!0})},o.onHeaderValue=function(e){s+=R.decode(e,{stream:!0})},o.onHeaderEnd=function(){if(s+=R.decode(),i=i.toLowerCase(),"content-disposition"===i){const e=s.match(/\bname=("([^"]*)"|([^()<>@,;:\\"/[\]?={}\s\t]+))/i);e&&(l=e[2]||e[3]||""),c=v(s),c&&(o.onPartData=p,o.onPartEnd=u)}else"content-type"===i&&(A=s);s="",i=""};for await(const e of r)o.write(e);return o.end(),f}E(v,"_fileName"),E(Z,"toFormData");export{Z as toFormData};
