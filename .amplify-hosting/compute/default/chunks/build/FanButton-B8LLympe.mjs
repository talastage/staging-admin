import{ref as a,useSSRContext as e,watch as n,mergeProps as t,withCtx as s,createTextVNode as r,toDisplayString as u,createVNode as l,openBlock as i,createBlock as o,createCommentVNode as c}from"vue";import{ssrRenderComponent as f,ssrInterpolate as d}from"vue/server-renderer";import{d as v,u as g,_ as p,b as m,V as h,U as y}from"./server.mjs";import{V as _}from"./VOverlay-ZKavbTei.mjs";const w=v("useUserFans",(()=>{const e=a([]),n=a([]),t=a(!1),s=a(!1),r=a(""),u=a({currentPage:1,lastPage:1,total:0}),l=a({currentPage:1,lastPage:1,total:0}),i=a({}),o=a({}),c=a({}),f=a({}),{$axios:d}=g();async function fetchUsers(a,e,n,u,l="",i=!1){if(i&&(n.value.currentPage=1,e.value=[]),!(n.value.currentPage>n.value.lastPage||t.value)){t.value=!0,s.value=!1,r.value="";try{const t=await d.get(a,{params:{search:l,page:n.value.currentPage}}),s=t.data[a.includes("fans")?"fans":"fanning"];1===n.value.currentPage||i?e.value=s:e.value.push(...s),n.value={currentPage:t.data.pagination.current_page+1,lastPage:t.data.pagination.last_page,total:t.data.pagination.total}}catch(e){console.error(`Failed to fetch ${a}:`,e),s.value=!0,r.value=`Failed to fetch ${a.includes("fans")?"fans":"fanning"}. Please try again later.`}finally{t.value=!1}}}return{fans:e,fanning:n,isFetching:t,isError:s,errorMessage:r,fansPagination:u,fanningPagination:l,fanCounts:i,fanningCounts:o,fanStatusCache:c,loading:f,fetchFans:async function(a,n="",t=!1){await fetchUsers(`/api/fans/${a}/fans`,e,u,0,n,t)},fetchFanning:async function(a,e="",t=!1){await fetchUsers(`/api/fans/${a}/fanning`,n,l,0,e,t)},fetchFansCount:async function(a){try{if(c.value[a])return i.value[a]=c.value[a].fan_count,i.value[a];const e=await d.get(`/api/fans/${a}/fans/count`);return i.value[a]=e.data.count,i.value[a]}catch(a){throw console.error("Error fetching fan count:",a),a}},fetchFanningCount:async function(a){try{const e=await d.get(`/api/fans/${a}/fanning/count`);return o.value[a]=e.data.count,o.value[a]}catch(a){throw console.error("Error fetching fanning count:",a),a}},getFanStatus:async function(a){if(f.value[a])return c.value[a]||{is_fanning:!1,fan_count:0};f.value[a]=!0;try{const e=await d.get(`/api/fans/${a}/status`);return e.data.success?(c.value[a]=e.data.data,i.value[a]=e.data.data.fan_count,e.data.data):{is_fanning:!1,fan_count:0}}catch(a){return console.error("Error fetching fan status:",a),{is_fanning:!1,fan_count:0}}finally{f.value[a]=!1}},toggleFan:async function(a){var t,s;f.value[a]=!0;try{const t=await d.post(`/api/fans/${a}/toggle`);return t.data.success?(c.value[a]=t.data.data,i.value[a]=t.data.data.fan_count,function(a,t){const s=e.value.findIndex((e=>e.username===a));-1!==s&&(e.value[s].is_fanned_by_auth_user=t);const r=n.value.findIndex((e=>e.username===a));-1!==r&&(n.value[r].is_fanned_by_auth_user=t)}(a,t.data.data.is_fanning),{success:!0,...t.data.data}):{success:!1,message:"Failed to update fan status"}}catch(a){return console.error("Error toggling fan status:",a),{success:!1,message:(null==(s=null==(t=a.response)?void 0:t.data)?void 0:s.message)||"An error occurred"}}finally{f.value[a]=!1}},clearCache:function(a=null){a?delete c.value[a]:c.value={}},$reset:function(){e.value=[],n.value=[],t.value=!1,s.value=!1,r.value="",u.value={currentPage:1,lastPage:1,total:0},l.value={currentPage:1,lastPage:1,total:0},i.value={},o.value={},c.value={},f.value={}}}})),F={__name:"FanButton",__ssrInlineRender:!0,props:{username:{type:String,required:!0},size:{type:String,default:"medium",validator:a=>["small","medium","large"].includes(a)},disabled:{type:Boolean,default:!1}},emits:["fanningUpdated"],setup(e,{emit:v}){const p=e,F=v,P=g(),$=w(),b=a(!1),U=a(!1),toggleFanStatus=async()=>{if(U.value||p.disabled)return;const a=b.value;b.value=!b.value,U.value=!0,F("fanningUpdated",b.value);try{await P.$protectedAction((async()=>{const a=await $.toggleFan(p.username);if(a.success)return b.value=a.is_fanning,F("fanningUpdated",a.is_fanning),a;throw new Error(a.message||"Failed to update fan status")}),{onSuccess:()=>{console.log(`User ${b.value?"fanned":"unfanned"} successfully`)},onError:e=>{var n;b.value=a,F("fanningUpdated",a),console.error("Error updating fan status:",e),null==(n=P.$toast)||n.error("Failed to update fan status. Please try again.")},requiresAuth:!0})}catch(e){b.value=a,F("fanningUpdated",a),console.error("Unexpected error:",e)}finally{U.value=!1}};return n((()=>p.username),(async()=>{if(p.username)try{const a=await $.getFanStatus(p.username);b.value=a.is_fanning}catch(a){console.error("Error loading fan status:",a)}})),(a,n,v,g)=>{n(f(m,t({color:b.value?"primary":"surface-variant",variant:b.value?"flat":"outlined",onClick:toggleFanStatus,rounded:"pill",class:{"fan-btn":!0,"fan-btn--active":b.value,[`fan-btn--${e.size}`]:!0},"min-width":"small"===e.size?80:"large"===e.size?120:100,disabled:e.disabled,elevation:"2"},g),{default:s(((a,e,n,t)=>{if(!e)return[l(h,{class:["fan-icon",{"fan-icon--active":b.value}],size:"small",start:""},{default:s((()=>[r(u(b.value?"mdi-heart":"mdi-heart-outline"),1)])),_:1},8,["class"]),l("span",{class:"fan-text"},u(b.value?"Following":"Follow"),1),U.value?(i(),o(_,{key:0,contained:"",class:"loading-overlay",opacity:"0.3"},{default:s((()=>[l(y,{indeterminate:"",size:"16",width:"2",color:"primary"})])),_:1})):c("",!0)];e(f(h,{class:["fan-icon",{"fan-icon--active":b.value}],size:"small",start:""},{default:s(((a,e,n,t)=>{if(!e)return[r(u(b.value?"mdi-heart":"mdi-heart-outline"),1)];e(`${d(b.value?"mdi-heart":"mdi-heart-outline")}`)})),_:1},n,t)),e(`<span class="fan-text" data-v-a936beb5${t}>${d(b.value?"Following":"Follow")}</span>`),U.value?e(f(_,{contained:"",class:"loading-overlay",opacity:"0.3"},{default:s(((a,e,n,t)=>{if(!e)return[l(y,{indeterminate:"",size:"16",width:"2",color:"primary"})];e(f(y,{indeterminate:"",size:"16",width:"2",color:"primary"},null,n,t))})),_:1},n,t)):e("\x3c!----\x3e")})),_:1},v))}}},P=F.setup;F.setup=(a,n)=>{const t=e();return(t.modules||(t.modules=new Set)).add("components/fans/FanButton.vue"),P?P(a,n):void 0};const $=p(F,[["__scopeId","data-v-a936beb5"]]);export{$ as _};
