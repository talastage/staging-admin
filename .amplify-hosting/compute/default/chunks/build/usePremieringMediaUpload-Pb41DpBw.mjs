import{d as e,u as l}from"./server.mjs";import{ref as a,computed as s}from"vue";import{u as r}from"./usePusher-CX6o09md.mjs";import{u as i}from"./useVaporUpload-BcV2ypUE.mjs";import{s as t}from"./interval-gl53xdpR.mjs";function extractErrorMessage(e){var l,a,s,r;const i=null==(a=null==(l=e.response)?void 0:l.data)?void 0:a.logs;return i&&Array.isArray(i)&&i.length>0?i[0].error_message||"An error occurred":(null==(r=null==(s=e.response)?void 0:s.data)?void 0:r.message)||e.message||"An error occurred"}const o=e("premieringMediaUpload",(()=>{const{$axios:e}=l(),{subscribeTo:o,unsubscribeFrom:u}=r(),n=a(null),p=a(null),c=a(!1),d=a(!1),v=a({xhr:null}),g=a({xhr:null}),m=a({isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}),f=a({isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}),U=s((()=>null!==n.value&&"failed"!==m.value.processingStatus)),_=s((()=>m.value.isUploading||f.value.isUploading));function updateProject(e){n.value?n.value={...n.value,...e}:n.value=e,n.value.project_url?(m.value.processingStatus="completed",m.value.fileUrl=n.value.project_url,m.value.manifestUrl=n.value.project_url,m.value.progress=100):m.value.isUploading||(m.value.processingStatus="pending"),n.value.trailer_url?(f.value.processingStatus="completed",f.value.fileUrl=n.value.trailer_url,f.value.manifestUrl=n.value.trailer_url,f.value.progress=100):f.value.isUploading||(f.value.processingStatus="pending")}function updateUploadStateFromProject(e){if(updateProject(e),e.main_meta&&null===m.value.fileName&&(m.value.fileName=e.name||e.main_meta.original_filename||null,m.value.fileSize=e.main_meta.original_filesize||0,m.value.uploadedSize=e.main_meta.original_filesize||0),e.trailer_meta&&null===f.value.fileName&&(f.value.fileName=e.trailer_meta.original_filename||null,f.value.fileSize=e.trailer_meta.original_filesize||0,f.value.uploadedSize=e.trailer_meta.original_filesize||0),e.logs&&e.logs.length>0){const l=e.logs.filter((e=>"main"===e.file_type)),a=l.length>0?l[l.length-1]:null;a&&!m.value.isUploading&&(m.value.processingStatus=a.processing_status,"failed"===a.processing_status&&a.error_message&&(p.value=a.error_message));const s=e.logs.filter((e=>"trailer"===e.file_type)),r=s.length>0?s[s.length-1]:null;r&&!f.value.isUploading&&(f.value.processingStatus=r.processing_status,"failed"===r.processing_status&&r.error_message&&(p.value=r.error_message))}e.main_upload_status&&("completed"===e.main_upload_status?(m.value.processingStatus="completed",m.value.progress=100,m.value.isUploading=!1):"failed"===e.main_upload_status?(m.value.processingStatus="failed",m.value.isUploading=!1):"processing"===e.main_upload_status&&(m.value.processingStatus="processing",m.value.progress=99)),e.trailer_upload_status&&("completed"===e.trailer_upload_status?(f.value.processingStatus="completed",f.value.progress=100,f.value.isUploading=!1):"failed"===e.trailer_upload_status?(f.value.processingStatus="failed",f.value.isUploading=!1):"processing"===e.trailer_upload_status&&(f.value.processingStatus="processing",f.value.progress=99))}function cancelUpload(e){const l="main"===e?v:g,a="main"===e?m:f;if(l.value.xhr)try{l.value.xhr.abort()}catch(e){console.error("Error aborting XHR:",e)}l.value.xhr=null,a.value={isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}}let S=null;function subscribeToProcessingUpdates(){if(n.value)try{const e=o(`project.${n.value.id}.main`),l=o(`project.${n.value.id}.trailer`);e&&e.bind("VideoProcessed",(e=>{console.log("Main VideoProcessed event received:",e),handleVideoProcessedEvent(e,"main")})),l&&l.bind("VideoProcessed",(e=>{console.log("Trailer VideoProcessed event received:",e),handleVideoProcessedEvent(e,"trailer")})),startPollingFallback()}catch(e){console.error("Error subscribing to processing updates:",e),p.value="Failed to setup processing notifications",startPollingFallback()}}function handleVideoProcessedEvent(e,l){var a;try{if(e.project.access_uuid!==(null==(a=n.value)?void 0:a.access_uuid))return;if(e.fileType!==l)return;S&&(clearInterval(S),S=null),updateUploadStateFromProject(e.project);const s="main"===e.fileType?m:f,r="main"===e.fileType?e.project.main_upload_status:e.project.trailer_upload_status;"completed"===r||"failed"===r?(s.value.processingStatus="completed"===r?"completed":"failed",s.value.progress="completed"===r?100:0,s.value.isUploading=!1):"processing"===r&&(s.value.processingStatus="processing",s.value.progress=99),e.manifestUrl&&(s.value.manifestUrl=e.manifestUrl,s.value.fileUrl=e.manifestUrl),e.failCause&&(s.value.error=e.failCause,p.value=e.failCause)}catch(e){console.error("Error processing VideoProcessed event:",e),p.value="Error processing video update"}}function startPollingFallback(){S||(S=t())}function resetUploadStates(){m.value={isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null},f.value={isUploading:!1,progress:0,error:null,fileName:null,fileSize:0,uploadedSize:0,processingStatus:"pending",manifestUrl:null,fileUrl:null,speed:0,estimatedTimeRemaining:0,startTime:null}}return{project:n,error:p,insufficientFunds:c,isLoading:d,mainUpload:m,trailerUpload:f,canUploadTrailer:U,isAnyUploadInProgress:_,createProject:async function(l){var a;d.value=!0,p.value=null,c.value=!1;try{const{data:a}=await e.post("/api/studio/projects/create",l);(null==a?void 0:a.project)&&(n.value=a.project,subscribeToProcessingUpdates())}catch(e){const l=null==(a=e.response)?void 0:a.status,s=extractErrorMessage(e);throw 422===l&&s.toLowerCase().includes("insufficient balance")&&(c.value=!0),p.value=s,e}finally{d.value=!1}},uploadFile:async function(e,l){var a,s;const r="main"===l?m:f,t="main"===l?v:g;try{r.value.isUploading=!0,r.value.fileName=e.name,r.value.fileSize=e.size,r.value.progress=0,r.value.error=null,r.value.startTime=Date.now(),r.value.speed=0,r.value.estimatedTimeRemaining=0,p.value=null;const{uploadFile:t}=i();await t(e,`/api/studio/projects/${null==(a=n.value)?void 0:a.access_uuid}/presigned-url`,`/api/studio/projects/${null==(s=n.value)?void 0:s.access_uuid}/confirm-upload`,{fileType:l,onProgress:l=>{!function(e,l,a){const s=Date.now();e.value.startTime||(e.value.startTime=s);const r=Math.round(l/a*100),i=(s-e.value.startTime)/1e3,t=l/i,o=(a-l)/t;e.value.progress=r,e.value.uploadedSize=l,e.value.speed=t,e.value.estimatedTimeRemaining=o}(r,l/100*e.size,e.size)},onSuccess:()=>{r.value.processingStatus="processing",r.value.progress=99},onError:e=>{throw e}})}catch(e){const l=extractErrorMessage(e);throw r.value.error=l,r.value.processingStatus="failed",r.value.isUploading=!1,p.value=l,new Error(l)}finally{t.value.xhr=null}},cancelUpload:cancelUpload,cleanup:function(){n.value&&(u(`project.${n.value.id}.main`),u(`project.${n.value.id}.trailer`)),S&&(clearInterval(S),S=null),cancelUpload("main"),cancelUpload("trailer"),n.value=null,p.value=null,c.value=!1,resetUploadStates()},resetUploadStates:resetUploadStates,subscribeToProcessingUpdates:subscribeToProcessingUpdates,updateUploadStateFromProject:updateUploadStateFromProject,updateProject:updateProject}}));export{o as u};
