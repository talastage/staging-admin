import{useSSRContext as e,defineComponent as a,ref as l,watch as o,mergeProps as t,withCtx as r,createVNode as s,createTextVNode as i,toDisplayString as d,unref as u,openBlock as n,createBlock as p}from"vue";import{ssrRenderAttrs as c,ssrRenderComponent as v,ssrRenderStyle as f,ssrInterpolate as m}from"vue/server-renderer";import{u as h,b as g,V as y,U as _,a as b,_ as P}from"./server.mjs";import w from"vue-cropperjs";import{V as C}from"./VAvatar-JL8WKjry.mjs";import{V as U}from"./VImg-B2jcJjnn.mjs";import{V as k}from"./VDialog-DA9BdIfh.mjs";import{V as x,b as j,a as S,c as z}from"./VCard-CsohsM82.mjs";import{u as E}from"./useProfileOwnership-UkSlwWA2.mjs";import{u as V}from"./useVaporUpload-BcV2ypUE.mjs";const $=a({__name:"ProfilePhoto",__ssrInlineRender:!0,props:{photoUrl:{type:String,default:""},defaultPhotoUrl:{type:String,required:!0},size:{type:[Number,String],default:100},canEdit:{type:Boolean,default:!1},alt:{type:String,default:"Profile Photo"},dialogTitle:{type:String,default:"Edit Photo"},variant:{type:String,default:"flat"},color:{type:String,default:"transparent"},avatarClass:{type:String,default:""},containerClass:{type:String,default:""}},emits:["upload-photo","photo-updated","upload-success","upload-error"],setup(e,{expose:a,emit:b}){const P=e,E=b,V=l(null),$=l(!1),A=l(!1),I=l(!1),T=l(null),B=l(null),L=l(P.photoUrl||P.defaultPhotoUrl);h();const F={circular:!0};o((()=>P.photoUrl),(e=>{L.value=e||P.defaultPhotoUrl}));const handleImageError=()=>{L.value=P.defaultPhotoUrl},selectFile=()=>{T.value.click()},closeDialog=()=>{I.value||($.value=!1,V.value=null,I.value=!1,A.value=!1,T.value&&(T.value.value=""))},handleUploadSuccess=e=>{I.value=!1,L.value=e,closeDialog(),E("upload-success",e)},handleUploadError=e=>{I.value=!1,A.value=!1,E("upload-error",e)},applyCrop=async()=>{if(B.value){A.value=!0;try{const e=B.value.getCroppedCanvas({width:300,height:300}),a=await new Promise((a=>e.toBlob(a,"image/jpeg",.8)));I.value=!0,A.value=!1,E("upload-photo",{blob:a,croppedCanvas:e,onSuccess:handleUploadSuccess,onError:handleUploadError})}catch(e){console.error("Error processing image:",e),alert("Failed to process image. Please try again."),A.value=!1}}};return a({handleUploadSuccess:handleUploadSuccess,handleUploadError:handleUploadError}),(a,l,o,h)=>{const b={style:{"--075a7c76":e.size+"px"}};l(`<div${c(t({class:["profile-photo-container",e.containerClass]},h,b))} data-v-4a4fc3df>`),l(v(C,{size:e.size,variant:e.variant,color:e.color,class:e.avatarClass},{default:r(((a,l,o,t)=>{if(!l)return[s(U,{src:L.value,alt:e.alt,cover:"",onError:handleImageError},null,8,["src","alt"])];l(v(U,{src:L.value,alt:e.alt,cover:"",onError:handleImageError},null,o,t))})),_:1},o)),e.canEdit?(l('<div class="camera-button-wrapper" data-v-4a4fc3df>'),l(v(g,{icon:"",density:"comfortable",variant:"flat",class:"camera-button",onClick:selectFile},{default:r(((e,a,l,o)=>{if(!a)return[s(y,{size:"16"},{default:r((()=>[i("mdi-camera")])),_:1})];a(v(y,{size:"16"},{default:r(((e,a,l,o)=>{if(!a)return[i("mdi-camera")];a("mdi-camera")})),_:1},l,o))})),_:1},o)),l("</div>")):l("\x3c!----\x3e"),l(`<input type="file" accept="image/*" style="${f({display:"none"})}" data-v-4a4fc3df>`),l(v(k,{modelValue:$.value,"onUpdate:modelValue":e=>$.value=e,"max-width":"600px",persistent:""},{default:r(((a,l,o,t)=>{if(!l)return[s(x,null,{default:r((()=>[s(j,null,{default:r((()=>[i(d(e.dialogTitle),1)])),_:1}),s(S,null,{default:r((()=>[V.value&&!I.value?(n(),p("div",{key:0},[s(u(w),{ref_key:"cropper",ref:B,src:V.value,"aspect-ratio":1,"view-mode":1,style:{height:"400px",width:"100%"},"stencil-props":F},null,8,["src"])])):I.value?(n(),p("div",{key:1,class:"upload-progress-container"},[s("div",{class:"text-center"},[s(_,{indeterminate:"",color:"primary",size:"64",class:"mb-4"}),s("h3",{class:"mb-2"},"Uploading Photo..."),s("p",{class:"text-medium-emphasis"}," Please wait while your photo is being uploaded and processed. ")])])):(n(),p("div",{key:2},[s("p",null,"Loading image...")]))])),_:1}),s(z,{class:"justify-end"},{default:r((()=>[s(g,{color:"secondary",text:"",onClick:closeDialog,disabled:I.value},{default:r((()=>[i(" Cancel ")])),_:1},8,["disabled"]),s(g,{color:"primary",loading:A.value,onClick:applyCrop,disabled:I.value},{default:r((()=>[i(" Apply ")])),_:1},8,["loading","disabled"])])),_:1})])),_:1})];l(v(x,null,{default:r(((a,l,o,t)=>{if(!l)return[s(j,null,{default:r((()=>[i(d(e.dialogTitle),1)])),_:1}),s(S,null,{default:r((()=>[V.value&&!I.value?(n(),p("div",{key:0},[s(u(w),{ref_key:"cropper",ref:B,src:V.value,"aspect-ratio":1,"view-mode":1,style:{height:"400px",width:"100%"},"stencil-props":F},null,8,["src"])])):I.value?(n(),p("div",{key:1,class:"upload-progress-container"},[s("div",{class:"text-center"},[s(_,{indeterminate:"",color:"primary",size:"64",class:"mb-4"}),s("h3",{class:"mb-2"},"Uploading Photo..."),s("p",{class:"text-medium-emphasis"}," Please wait while your photo is being uploaded and processed. ")])])):(n(),p("div",{key:2},[s("p",null,"Loading image...")]))])),_:1}),s(z,{class:"justify-end"},{default:r((()=>[s(g,{color:"secondary",text:"",onClick:closeDialog,disabled:I.value},{default:r((()=>[i(" Cancel ")])),_:1},8,["disabled"]),s(g,{color:"primary",loading:A.value,onClick:applyCrop,disabled:I.value},{default:r((()=>[i(" Apply ")])),_:1},8,["loading","disabled"])])),_:1})];l(v(j,null,{default:r(((a,l,o,t)=>{if(!l)return[i(d(e.dialogTitle),1)];l(`${m(e.dialogTitle)}`)})),_:1},o,t)),l(v(S,null,{default:r(((e,a,l,o)=>{if(!a)return[V.value&&!I.value?(n(),p("div",{key:0},[s(u(w),{ref_key:"cropper",ref:B,src:V.value,"aspect-ratio":1,"view-mode":1,style:{height:"400px",width:"100%"},"stencil-props":F},null,8,["src"])])):I.value?(n(),p("div",{key:1,class:"upload-progress-container"},[s("div",{class:"text-center"},[s(_,{indeterminate:"",color:"primary",size:"64",class:"mb-4"}),s("h3",{class:"mb-2"},"Uploading Photo..."),s("p",{class:"text-medium-emphasis"}," Please wait while your photo is being uploaded and processed. ")])])):(n(),p("div",{key:2},[s("p",null,"Loading image...")]))];V.value&&!I.value?(a(`<div data-v-4a4fc3df${o}>`),a(v(u(w),{ref_key:"cropper",ref:B,src:V.value,"aspect-ratio":1,"view-mode":1,style:{height:"400px",width:"100%"},"stencil-props":F},null,l,o)),a("</div>")):I.value?(a(`<div class="upload-progress-container" data-v-4a4fc3df${o}><div class="text-center" data-v-4a4fc3df${o}>`),a(v(_,{indeterminate:"",color:"primary",size:"64",class:"mb-4"},null,l,o)),a(`<h3 class="mb-2" data-v-4a4fc3df${o}>Uploading Photo...</h3><p class="text-medium-emphasis" data-v-4a4fc3df${o}> Please wait while your photo is being uploaded and processed. </p></div></div>`)):a(`<div data-v-4a4fc3df${o}><p data-v-4a4fc3df${o}>Loading image...</p></div>`)})),_:1},o,t)),l(v(z,{class:"justify-end"},{default:r(((e,a,l,o)=>{if(!a)return[s(g,{color:"secondary",text:"",onClick:closeDialog,disabled:I.value},{default:r((()=>[i(" Cancel ")])),_:1},8,["disabled"]),s(g,{color:"primary",loading:A.value,onClick:applyCrop,disabled:I.value},{default:r((()=>[i(" Apply ")])),_:1},8,["loading","disabled"])];a(v(g,{color:"secondary",text:"",onClick:closeDialog,disabled:I.value},{default:r(((e,a,l,o)=>{if(!a)return[i(" Cancel ")];a(" Cancel ")})),_:1},l,o)),a(v(g,{color:"primary",loading:A.value,onClick:applyCrop,disabled:I.value},{default:r(((e,a,l,o)=>{if(!a)return[i(" Apply ")];a(" Apply ")})),_:1},l,o))})),_:1},o,t))})),_:1},o,t))})),_:1},o)),l("</div>")}}}),A=$.setup;$.setup=(a,l)=>{const o=e();return(o.modules||(o.modules=new Set)).add("components/shared/ProfilePhoto.vue"),A?A(a,l):void 0};const I=P($,[["__scopeId","data-v-4a4fc3df"]]),T=a({__name:"UserProfilePhoto",__ssrInlineRender:!0,props:{user:{type:Object,required:!0},size:{type:[Number,String],default:100}},emits:["photo-updated"],setup(e,{emit:a}){var l;const o=e,r=a;h();const s=b(),{uploadFile:i}=V(),{isProfileOwner:d}=E(null==(l=o.user)?void 0:l.username),handlePhotoUpload=async({blob:e,onSuccess:a,onError:l,onProgress:o})=>{var t,d;try{const l=await(async(e,a)=>await i(e,"/api/profile/photo-upload-url","/api/profile/confirm-photo-upload",{onProgress:a}))(e,o);s.updateUser(l.user),a&&a(l.user.profile_photo),r("photo-updated")}catch(e){console.error("Error uploading image:",e),l&&l(e);const a=(null==(d=null==(t=e.response)?void 0:t.data)?void 0:d.message)||e.message||"Failed to upload image. Please try again.";alert(a)}};return(a,l,o,r)=>{var s;l(v(I,t({photoUrl:e.user.profile_photo,defaultPhotoUrl:"/images/profile/default.png",size:e.size,canEdit:u(d),alt:`${(null==(s=e.user)?void 0:s.username)||"User"}'s profile photo`,dialogTitle:"Edit Profile Photo",avatarClass:"profile-avatar",containerClass:"user-profile-photo",onUploadPhoto:handlePhotoUpload},r),null,o))}}}),B=T.setup;T.setup=(a,l)=>{const o=e();return(o.modules||(o.modules=new Set)).add("components/user/UserProfilePhoto.vue"),B?B(a,l):void 0};const L=P(T,[["__scopeId","data-v-ec383e79"]]);export{L as _};
