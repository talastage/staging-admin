import{useSSRContext as e,ref as a,reactive as t,defineComponent as l,computed as r,watch as s,mergeProps as c,unref as i,withCtx as n,createTextVNode as u,createVNode as d,openBlock as o,createBlock as v,toDisplayString as y,createCommentVNode as m}from"vue";import{ssrRenderAttrs as p,ssrRenderAttr as f,ssrInterpolate as g,ssrRenderList as w,ssrIncludeBooleanAttr as h,ssrLooseContain as _,ssrLooseEqual as x,ssrRenderComponent as C}from"vue/server-renderer";import{d as b,u as $,V as k,b as S,_ as V,f as A}from"./server.mjs";import{u as z}from"./useWalletStore-C5It8oQZ.mjs";import{isAxiosError as E}from"axios";import{V as I}from"./VAvatar-JL8WKjry.mjs";import{V as P,a as W}from"./VCard-CsohsM82.mjs";import{V as F}from"./VForm-HRC00ryg.mjs";import{V as B}from"./VSnackbar-zBX8NfdO.mjs";function useCurrencies(){const{$axios:e}=$(),t=a([]),l=a(null),s=a(!1),c=a(null),i=a(!1),n=r((()=>l.value||null)),u=r((()=>t.value)),fetchCurrencies=async()=>{if(!s.value){s.value=!0,c.value=null;try{const a=await e.get("/api/currencies");console.log("API Response:",a.data);const{currencies:r,user_currency:s}=a.data;return t.value=r||[],l.value=s||null,i.value=!0,{currencies:r,userCurrency:s}}catch(e){throw c.value=e.message||"Failed to fetch currencies",console.error("Error fetching currencies:",e),e}finally{s.value=!1}}};return{currencies:t,activeCurrencies:u,userCurrency:l,selectedCurrency:n,isLoading:s,error:c,isFetched:i,fetchCurrencies:fetchCurrencies,fetchGuestCurrencies:async()=>{if(!s.value){s.value=!0,c.value=null;try{const a=await e.get("/api/currencies");return console.log("Guest API Response:",a.data),t.value=a.data.currencies||a.data.data||[],i.value=!0,t.value}catch(e){throw c.value=e.message||"Failed to fetch guest currencies",console.error("Error fetching guest currencies:",e),e}finally{s.value=!1}}},updateUserCurrency:async a=>{s.value=!0,c.value=null;try{const t=await e.post("/api/user/currency",{currency_code:a});return await fetchCurrencies(),t.data}catch(e){throw c.value=e.message||"Failed to update currency",console.error("Error updating currency:",e),e}finally{s.value=!1}},updateWalletCurrency:async(a,t)=>{s.value=!0,c.value=null;try{const l=await e.post(`/api/wallet/${a}/currency`,{currency_id:t});return await fetchCurrencies(),l.data}catch(e){throw c.value=e.message||"Failed to update wallet currency",console.error("Error updating wallet currency:",e),e}finally{s.value=!1}},getCurrencyById:e=>t.value.find((a=>a.id===e)),getCurrencyByCode:e=>t.value.find((a=>a.code===e))}}const j=l({__name:"CurrencyCountrySelector",__ssrInlineRender:!0,props:{modelValue:{type:Number,default:null},label:{type:String,default:"Select Currency"},autoLoad:{type:Boolean,default:!0},id:{type:String,default:()=>`currency-selector-${Math.random().toString(36).substring(2,9)}`}},emits:["update:modelValue","change"],setup(e,{expose:t,emit:l}){const n=e,u=l,{currencies:d,userCurrency:o,isLoading:v,error:y,fetchCurrencies:m}=useCurrencies(),C=a(n.modelValue),b=r((()=>C.value&&d.value.find((e=>e.id===C.value))||null));return s((()=>n.modelValue),(e=>{e!==C.value&&(C.value=e)})),s(o,(e=>{e&&!n.modelValue&&(C.value=e.id,u("update:modelValue",e.id))})),t({reload:m,currencies:d,selectedCurrency:b}),(a,t,l,r)=>{t(`<div${p(c({class:"currency-selector"},r))} data-v-5d0de089>`),i(v)?t('<div class="currency-selector__loading" data-v-5d0de089><span class="loader" data-v-5d0de089></span></div>'):(t('<div class="currency-selector__container" data-v-5d0de089>'),e.label?t(`<label${f("for",e.id)} class="currency-selector__label" data-v-5d0de089>${g(e.label)}</label>`):t("\x3c!----\x3e"),t(`<div class="currency-selector__select-wrapper" data-v-5d0de089><select${f("id",e.id)} class="currency-selector__select" data-v-5d0de089>\x3c!--[--\x3e`),w(i(d),(a=>{t(`<option${f("value",a.id)}${h(a.id===e.modelValue)?" selected":""} data-v-5d0de089${h(Array.isArray(C.value)?_(C.value,a.id):x(C.value,a.id))?" selected":""}>${g(a.name)} (${g(a.code)}) </option>`)})),t("\x3c!--]--\x3e</select>"),b.value?t(`<div class="currency-selector__selected" data-v-5d0de089><span class="currency-selector__symbol" data-v-5d0de089>${g(b.value.symbol)}</span><span class="currency-selector__code" data-v-5d0de089>${g(b.value.code)}</span></div>`):t("\x3c!----\x3e"),t("</div>"),i(y)?t(`<p class="currency-selector__error" data-v-5d0de089>${g(i(y))}</p>`):t("\x3c!----\x3e"),t("</div>")),t("</div>")}}}),N=j.setup;j.setup=(a,t)=>{const l=e();return(l.modules||(l.modules=new Set)).add("components/currency/CurrencyCountrySelector.vue"),N?N(a,t):void 0};const L=V(j,[["__scopeId","data-v-5d0de089"]]),R=b("wallet-activation",(()=>{const{$axios:e}=$(),l=z(),r=a(!1),s=a("email"),c=a(!0),i=t({isActivated:!1,isPending:!1,lastAttempt:null}),handleActivationError=e=>{var a,t,l,r,s,c,i;if(E(e)){const n=e;throw{message:(null==(t=null==(a=n.response)?void 0:a.data)?void 0:t.message)||n.message,details:null==(r=null==(l=n.response)?void 0:l.data)?void 0:r.details,status:null==(s=n.response)?void 0:s.status,code:null==(i=null==(c=n.response)?void 0:c.data)?void 0:i.code}}throw{message:e instanceof Error?e.message:"An unexpected error occurred"}};return{isLoading:r,activationMethod:s,canActivateByEmail:c,activationStatus:i,checkActivationEligibility:async()=>{try{r.value=!0;const{data:a}=await e.get("/api/wallet/activation/eligibility");return c.value=a.canActivateByEmail||!1,i.isActivated=a.isActivated||!1,i.isPending=a.isPending||!1,a}catch(e){return handleActivationError(e)}finally{r.value=!1}},sendActivationCode:async()=>{try{r.value=!0;const{data:a}=await e.post("/api/wallet/activation/send-code",{method:s.value});return i.lastAttempt=new Date,i.isPending=!0,a}catch(e){return handleActivationError(e)}finally{r.value=!1}},verifyActivationCode:async a=>{try{r.value=!0;const{data:t}=await e.post("/api/wallet/activation/verify-code",{code:a,method:s.value});return t.authorized&&(i.isPending=!1),t}catch(e){return handleActivationError(e)}finally{r.value=!1}},resendActivationCode:async()=>{try{r.value=!0;const{data:a}=await e.post("/api/wallet/activation/resend-code",{method:s.value});return i.lastAttempt=new Date,a}catch(e){return handleActivationError(e)}finally{r.value=!1}},completeActivation:async a=>{try{r.value=!0;const t=a?{currency_id:a}:{},{data:s}=await e.post("/api/wallet/activation/complete",t);return s.success&&(i.isActivated=!0,i.isPending=!1,await l.fetchWallet()),s}catch(e){return handleActivationError(e)}finally{r.value=!1}},verifyPin:async a=>{try{const{data:t}=await e.post("/api/wallet/verify-generated-pin",{pin:a});return t.authorized&&(l.setAuthenticated(!0),t.expires_at&&l.setSessionExpiry(t.expires_at),await l.fetchWallet()),t}catch(e){return handleActivationError(e)}},generateNewPin:async a=>{try{const{data:t}=await e.post("/api/wallet/generate-pin",{email:a});return t}catch(e){return handleActivationError(e)}},verifyGeneratedPin:async a=>{try{const{data:t}=await e.post("/api/wallet/verify-generated-pin",{pin:a});return t.authorized&&(l.setAuthenticated(!0),t.expires_at&&l.setSessionExpiry(t.expires_at),await l.fetchWallet()),t}catch(e){return handleActivationError(e)}}}})),U=l({__name:"WalletCurrencySelector",__ssrInlineRender:!0,props:{walletId:{type:Number,default:null},allowSkip:{type:Boolean,default:!1},preselectedCurrencyId:{type:Number,default:null}},emits:["success","skip","error"],setup(e,{emit:t}){const l=e,s=t,w=z(),h=R(),{userCurrency:_,currencies:x}=useCurrencies(),b=a(l.preselectedCurrencyId),V=a(!1),E=a(""),j=a(!1),N=a(""),U=a("success"),K=a(null),G=a(null),submitForm=async()=>{var e,a,t,r,c;if(b.value)try{V.value=!0,E.value="";let r=l.walletId;if(!r&&h.walletId?r=h.walletId:!r&&(null==(e=w.wallet)?void 0:e.id)?r=w.wallet.id:!r&&(null==(t=null==(a=h.activationStatus)?void 0:a.wallet)?void 0:t.id)&&(r=h.activationStatus.wallet.id),!r){const{$axios:e}=$();r=(await e.get("/api/wallet")).data.data.id}if(!r)throw new Error("No wallet found. Please try again later.");const{$axios:c}=$(),i=await c.post("/api/wallet/activation/complete",{currency_id:b.value});showSuccess("Wallet activated successfully"),s("success",i.data)}catch(e){console.error("Currency selection error:",e),showError((null==(c=null==(r=e.response)?void 0:r.data)?void 0:c.message)||e.message||"Failed to update currency"),s("error",e)}finally{V.value=!1}},skipSelection=async()=>{var e,a;try{V.value=!0;const{$axios:e}=$(),a=await e.post("/api/wallet/activation/complete");s("skip",a.data)}catch(t){showError((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message||"Failed to complete activation"),s("error",t)}finally{V.value=!1}},showSuccess=e=>{N.value=e,U.value="success",j.value=!0},showError=e=>{E.value=e,N.value=e,U.value="error",j.value=!0},getFullImagePath=e=>{if(!e)return"";if(e.startsWith("http"))return e;if(e.startsWith("/")){return`${A().public.apiBase||""}${e}`}return e},onImageError=e=>{console.warn("Failed to load currency flag image:",e)},M=r((()=>b.value!==G.value&&null!==b.value));return(a,t,l,r)=>{const s=L;t(`<div${p(c({class:"wallet-currency-selector"},r))} data-v-822d37d3><div class="currency-header mb-4" data-v-822d37d3><div class="text-center" data-v-822d37d3>`),t(C(I,{size:"40",color:"primary",class:"mb-3"},{default:n(((e,a,t,l)=>{if(!a)return[d(k,{color:"white",size:"20"},{default:n((()=>[u("mdi-currency-usd")])),_:1})];a(C(k,{color:"white",size:"20"},{default:n(((e,a,t,l)=>{if(!a)return[u("mdi-currency-usd")];a("mdi-currency-usd")})),_:1},t,l))})),_:1},l)),t('<h3 class="text-h6 font-weight-bold mb-2" data-v-822d37d3>Select Currency</h3><p class="text-body-2 text-medium-emphasis mb-0" data-v-822d37d3> Choose your wallet&#39;s default currency </p></div></div>'),i(_)?(t('<div class="current-currency-info mb-4" data-v-822d37d3>'),t(C(P,{class:"current-currency-card",elevation:"1",rounded:"lg"},{default:n(((e,a,t,l)=>{if(!a)return[d(W,{class:"pa-3"},{default:n((()=>[d("div",{class:"d-flex align-center"},[d(I,{size:"32",class:"mr-3"},{default:n((()=>[i(_).country_flag?(o(),v("img",{key:0,src:getFullImagePath(i(_).country_flag),alt:i(_).country_name||i(_).code,class:"currency-flag",onError:onImageError},null,40,["src","alt"])):(o(),v("span",{key:1,class:"text-caption font-weight-bold"},y(i(_).symbol),1))])),_:1}),d("div",{class:"flex-grow-1 min-width-0"},[d("div",{class:"text-caption text-medium-emphasis"},"Current Currency"),d("div",{class:"text-body-1 font-weight-medium text-truncate"},y(i(_).name),1),d("div",{class:"text-caption text-medium-emphasis"},y(i(_).code)+" • "+y(i(_).symbol),1)])])])),_:1})];a(C(W,{class:"pa-3"},{default:n(((e,a,t,l)=>{if(!a)return[d("div",{class:"d-flex align-center"},[d(I,{size:"32",class:"mr-3"},{default:n((()=>[i(_).country_flag?(o(),v("img",{key:0,src:getFullImagePath(i(_).country_flag),alt:i(_).country_name||i(_).code,class:"currency-flag",onError:onImageError},null,40,["src","alt"])):(o(),v("span",{key:1,class:"text-caption font-weight-bold"},y(i(_).symbol),1))])),_:1}),d("div",{class:"flex-grow-1 min-width-0"},[d("div",{class:"text-caption text-medium-emphasis"},"Current Currency"),d("div",{class:"text-body-1 font-weight-medium text-truncate"},y(i(_).name),1),d("div",{class:"text-caption text-medium-emphasis"},y(i(_).code)+" • "+y(i(_).symbol),1)])])];a(`<div class="d-flex align-center" data-v-822d37d3${l}>`),a(C(I,{size:"32",class:"mr-3"},{default:n(((e,a,t,l)=>{if(!a)return[i(_).country_flag?(o(),v("img",{key:0,src:getFullImagePath(i(_).country_flag),alt:i(_).country_name||i(_).code,class:"currency-flag",onError:onImageError},null,40,["src","alt"])):(o(),v("span",{key:1,class:"text-caption font-weight-bold"},y(i(_).symbol),1))];i(_).country_flag?a(`<img${f("src",getFullImagePath(i(_).country_flag))}${f("alt",i(_).country_name||i(_).code)} class="currency-flag" data-v-822d37d3${l}>`):a(`<span class="text-caption font-weight-bold" data-v-822d37d3${l}>${g(i(_).symbol)}</span>`)})),_:1},t,l)),a(`<div class="flex-grow-1 min-width-0" data-v-822d37d3${l}><div class="text-caption text-medium-emphasis" data-v-822d37d3${l}>Current Currency</div><div class="text-body-1 font-weight-medium text-truncate" data-v-822d37d3${l}>${g(i(_).name)}</div><div class="text-caption text-medium-emphasis" data-v-822d37d3${l}>${g(i(_).code)} • ${g(i(_).symbol)}</div></div></div>`)})),_:1},t,l))})),_:1},l)),t("</div>")):t("\x3c!----\x3e"),t(C(F,{ref_key:"form",ref:K,onSubmit:submitForm},{default:n(((a,t,l,r)=>{if(!t)return[d("div",{class:"currency-selector-section mb-4"},[d(s,{modelValue:b.value,"onUpdate:modelValue":e=>b.value=e,label:"Select Currency",density:"compact"},null,8,["modelValue","onUpdate:modelValue"])]),d("div",{class:"action-buttons mt-4"},[e.allowSkip&&i(_)?(o(),v(S,{key:0,variant:"outlined",onClick:skipSelection,disabled:V.value,size:"small",class:"mb-2",block:""},{default:n((()=>[d(k,{start:"",size:"16"},{default:n((()=>[u("mdi-skip-next")])),_:1}),u(" Keep Current ")])),_:1},8,["disabled"])):m("",!0),d(S,{color:"primary",type:"submit",loading:V.value,disabled:!b.value||V.value,size:"default",block:""},{default:n((()=>[d(k,{start:"",size:"18"},{default:n((()=>[u("mdi-check")])),_:1}),u(" "+y(M.value?"Confirm Currency":"Save Currency"),1)])),_:1},8,["loading","disabled"])])];t(`<div class="currency-selector-section mb-4" data-v-822d37d3${r}>`),t(C(s,{modelValue:b.value,"onUpdate:modelValue":e=>b.value=e,label:"Select Currency",density:"compact"},null,l,r)),t(`</div><div class="action-buttons mt-4" data-v-822d37d3${r}>`),e.allowSkip&&i(_)?t(C(S,{variant:"outlined",onClick:skipSelection,disabled:V.value,size:"small",class:"mb-2",block:""},{default:n(((e,a,t,l)=>{if(!a)return[d(k,{start:"",size:"16"},{default:n((()=>[u("mdi-skip-next")])),_:1}),u(" Keep Current ")];a(C(k,{start:"",size:"16"},{default:n(((e,a,t,l)=>{if(!a)return[u("mdi-skip-next")];a("mdi-skip-next")})),_:1},t,l)),a(" Keep Current ")})),_:1},l,r)):t("\x3c!----\x3e"),t(C(S,{color:"primary",type:"submit",loading:V.value,disabled:!b.value||V.value,size:"default",block:""},{default:n(((e,a,t,l)=>{if(!a)return[d(k,{start:"",size:"18"},{default:n((()=>[u("mdi-check")])),_:1}),u(" "+y(M.value?"Confirm Currency":"Save Currency"),1)];a(C(k,{start:"",size:"18"},{default:n(((e,a,t,l)=>{if(!a)return[u("mdi-check")];a("mdi-check")})),_:1},t,l)),a(` ${g(M.value?"Confirm Currency":"Save Currency")}`)})),_:1},l,r)),t("</div>")})),_:1},l)),t(C(B,{modelValue:j.value,"onUpdate:modelValue":e=>j.value=e,color:U.value,timeout:"5000"},{actions:n(((e,a,t,l)=>{if(!a)return[d(S,{variant:"text",onClick:e=>j.value=!1},{default:n((()=>[u(" Close ")])),_:1},8,["onClick"])];a(C(S,{variant:"text",onClick:e=>j.value=!1},{default:n(((e,a,t,l)=>{if(!a)return[u(" Close ")];a(" Close ")})),_:1},t,l))})),default:n(((e,a,t,l)=>{if(!a)return[u(y(N.value)+" ",1)];a(`${g(N.value)} `)})),_:1},l)),t("</div>")}}}),K=U.setup;U.setup=(a,t)=>{const l=e();return(l.modules||(l.modules=new Set)).add("components/wallet/WalletCurrencySelector.vue"),K?K(a,t):void 0};const G=V(U,[["__scopeId","data-v-822d37d3"]]);export{G as _,R as u};
