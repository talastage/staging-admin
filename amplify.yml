version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing Node.js 20 LTS"
        - nvm install 20
        - nvm use 20
        - node --version
        - npm --version
        - echo "Installing pnpm package manager"
        - npm install -g pnpm@9
        - pnpm --version
        - echo "Cleaning previous build artifacts"
        - rm -rf node_modules .nuxt .output .amplify-hosting
        - echo "Installing dependencies with pnpm"
        - pnpm install --no-frozen-lockfile
    build:
      commands:
        - echo "Setting Node.js memory limit for build"
        - export NODE_OPTIONS="--max-old-space-size=4096"
        - export NITRO_PRESET=aws-amplify
        - echo "Building Nuxt app (SSR) with Node $(node -v) and pnpm $(pnpm -v)"
        - pnpm run build
        - echo "Preparing compute bundle for Amplify"
        - |
          COMPUTE_DIR=".amplify-hosting/compute/default"
          if [ -f "$COMPUTE_DIR/package.json" ]; then
            echo "Preparing npm lockfile in $COMPUTE_DIR for Amplify packaging"
            # Remove pnpm-specific fields that may cause issues with npm
            node -e "
              const fs = require('fs');
              const path = '$COMPUTE_DIR/package.json';
              const pkg = JSON.parse(fs.readFileSync(path, 'utf8'));
              delete pkg.packageManager;
              delete pkg.workspaces;
              fs.writeFileSync(path, JSON.stringify(pkg, null, 2));
            "
            (cd "$COMPUTE_DIR" && npm i --package-lock-only --ignore-scripts)
            echo "✅ Generated package-lock.json in $COMPUTE_DIR"
          else
            echo "ℹ️ No compute package.json found at $COMPUTE_DIR"
          fi
        - echo "Verifying deploy-manifest.json configuration"
        - |
          if [ -f ".amplify-hosting/deploy-manifest.json" ]; then
            echo "✅ Found deploy-manifest.json"
            cat .amplify-hosting/deploy-manifest.json | grep -i runtime || echo "Runtime configuration present"
          else
            echo "⚠️ No deploy-manifest.json found in .amplify-hosting"
          fi
  artifacts:
    baseDirectory: .amplify-hosting
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .pnpm-store/**/*
